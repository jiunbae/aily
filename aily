#!/bin/bash
# aily ‚Äî CLI for managing AI agent notification relay.
# Usage:
#   aily start [name]     Create Discord thread for current/named tmux session
#   aily stop [name]      Archive Discord thread for current/named tmux session
#   aily auto [on|off]    Toggle auto thread sync (or show status)
#   aily sessions         List all tmux sessions with Discord thread sync status
#   aily help             Show this help

set -euo pipefail

ENV_FILE="${AILY_ENV:-$HOME/.claude/hooks/.notify-env}"
HOOKS_DIR="$(dirname "$ENV_FILE")"

# --- helpers ---

env_get() {
  local key="$1" default="${2:-}"
  if [[ -f "$ENV_FILE" ]]; then
    local val
    val=$(grep -E "^${key}=" "$ENV_FILE" 2>/dev/null | tail -1 | cut -d= -f2- | tr -d '"' | tr -d "'")
    echo "${val:-$default}"
  else
    echo "$default"
  fi
}

env_set() {
  local key="$1" value="$2"
  if [[ ! -f "$ENV_FILE" ]]; then
    echo "  Error: $ENV_FILE not found" >&2
    exit 1
  fi
  if grep -qE "^${key}=" "$ENV_FILE" 2>/dev/null; then
    python3 -c "
import re, sys
path = sys.argv[1]
key, val = sys.argv[2], sys.argv[3]
with open(path) as f:
    text = f.read()
text = re.sub(rf'^{key}=.*$', f'{key}=\"{val}\"', text, flags=re.MULTILINE)
with open(path, 'w') as f:
    f.write(text)
" "$ENV_FILE" "$key" "$value"
  else
    echo "" >> "$ENV_FILE"
    echo "${key}=\"${value}\"" >> "$ENV_FILE"
  fi
}

detect_tmux_session() {
  local TMUX_BIN="/opt/homebrew/bin/tmux"
  if [[ ! -x "$TMUX_BIN" ]]; then
    TMUX_BIN="tmux"
  fi

  if [[ -n "${TMUX_PANE:-}" ]]; then
    "$TMUX_BIN" display-message -t "${TMUX_PANE}" -p '#{session_name}' 2>/dev/null || true
  elif [[ -n "${TMUX:-}" ]]; then
    "$TMUX_BIN" display-message -p '#S' 2>/dev/null || true
  fi
}

load_discord_env() {
  if [[ ! -f "$ENV_FILE" ]]; then
    echo "  Error: $ENV_FILE not found" >&2
    exit 1
  fi
  # shellcheck source=/dev/null
  source "$ENV_FILE"
  if [[ -z "${DISCORD_BOT_TOKEN:-}" || -z "${DISCORD_CHANNEL_ID:-}" ]]; then
    echo "  Error: DISCORD_BOT_TOKEN or DISCORD_CHANNEL_ID not set in $ENV_FILE" >&2
    exit 1
  fi
  local lib="${HOOKS_DIR}/discord-lib.sh"
  if [[ ! -f "$lib" ]]; then
    echo "  Error: discord-lib.sh not found at $lib" >&2
    exit 1
  fi
  # shellcheck source=/dev/null
  source "$lib"
}

# --- commands ---

cmd_start() {
  local session_name="${1:-}"
  if [[ -z "$session_name" ]]; then
    session_name=$(detect_tmux_session)
  fi
  if [[ -z "$session_name" ]]; then
    echo "  Error: not inside tmux. Provide a session name: aily start <name>" >&2
    exit 1
  fi

  load_discord_env

  local thread_name="[agent] ${session_name}"
  local hostname_short
  hostname_short=$(hostname -s 2>/dev/null || hostname)

  echo "  Starting thread for ${session_name}..."
  local thread_id
  thread_id=$(discord_ensure_thread "$thread_name" "üñ• **tmux session: ${thread_name}** (${hostname_short})")

  if [[ -n "$thread_id" ]]; then
    discord_post_to_thread "$thread_id" "‚ñ∂Ô∏è Session \`${session_name}\` started on \`${hostname_short}\` ¬∑ $(date '+%Y-%m-%d %H:%M:%S')"
    echo "  ‚úì Thread ready: [agent] ${session_name}"
  else
    echo "  ‚úó Failed to create thread" >&2
    exit 1
  fi
}

cmd_stop() {
  local session_name="${1:-}"
  if [[ -z "$session_name" ]]; then
    session_name=$(detect_tmux_session)
  fi
  if [[ -z "$session_name" ]]; then
    echo "  Error: not inside tmux. Provide a session name: aily stop <name>" >&2
    exit 1
  fi

  load_discord_env

  local thread_name="[agent] ${session_name}"
  local hostname_short
  hostname_short=$(hostname -s 2>/dev/null || hostname)

  echo "  Stopping thread for ${session_name}..."
  local thread_id
  thread_id=$(discord_find_thread "$thread_name")

  if [[ -n "$thread_id" ]]; then
    discord_post_to_thread "$thread_id" "‚èπÔ∏è Session \`${session_name}\` stopped on \`${hostname_short}\` ¬∑ $(date '+%Y-%m-%d %H:%M:%S')"
    discord_archive_thread "$thread_id"
    echo "  ‚úì Thread archived: [agent] ${session_name}"
  else
    echo "  No thread found for [agent] ${session_name}"
  fi
}

cmd_auto() {
  local action="${1:-}"
  case "$action" in
    on)
      env_set "TMUX_THREAD_SYNC" "true"
      echo "  Auto thread sync: ON"
      ;;
    off)
      env_set "TMUX_THREAD_SYNC" "false"
      echo "  Auto thread sync: OFF"
      ;;
    "")
      local current
      current=$(env_get "TMUX_THREAD_SYNC" "true")
      if [[ "$current" == "false" ]]; then
        echo "  Auto thread sync: OFF"
      else
        echo "  Auto thread sync: ON"
      fi
      ;;
    *)
      echo "Usage: aily auto [on|off]"
      exit 1
      ;;
  esac
}

cmd_sessions() {
  local hosts_str
  hosts_str=$(env_get "SSH_HOSTS" "jiun-mini,jiun-mbp")
  IFS=',' read -ra hosts <<< "$hosts_str"
  echo "  Checking sessions..."
  echo ""

  for host in "${hosts[@]}"; do
    local sessions
    sessions=$(ssh "$host" "tmux list-sessions -F '#{session_name}' 2>/dev/null" 2>/dev/null || echo "")
    if [[ -n "$sessions" ]]; then
      echo "  $host:"
      while IFS= read -r name; do
        echo "    $name"
      done <<< "$sessions"
      echo ""
    fi
  done
}

cmd_help() {
  echo "aily ‚Äî AI agent notification relay"
  echo ""
  echo "Usage:"
  echo "  aily start [name]     Create Discord thread (default: current tmux session)"
  echo "  aily stop [name]      Archive Discord thread (default: current tmux session)"
  echo "  aily auto [on|off]    Toggle auto thread sync (or show status)"
  echo "  aily sessions         List tmux sessions across hosts"
  echo "  aily help             Show this help"
}

# --- main ---

CMD="${1:-help}"
shift 2>/dev/null || true

case "$CMD" in
  start)    cmd_start "$@" ;;
  stop)     cmd_stop "$@" ;;
  auto)     cmd_auto "$@" ;;
  sessions) cmd_sessions "$@" ;;
  help|-h|--help) cmd_help ;;
  *)
    echo "Unknown command: $CMD"
    echo ""
    cmd_help
    exit 1
    ;;
esac
